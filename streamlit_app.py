import streamlit as st
import math

def calculate_geometric_ratio(first_term, nth_term, n):
    """
    ë“±ë¹„ìˆ˜ì—´ì˜ ì²«ì§¸ í•­, në²ˆì§¸ í•­, ê·¸ë¦¬ê³  nì„ ì…ë ¥ë°›ì•„ ê³µë¹„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.

    Args:
        first_term (float): ë“±ë¹„ìˆ˜ì—´ì˜ ì²«ì§¸ í•­ (a1).
        nth_term (float): ë“±ë¹„ìˆ˜ì—´ì˜ në²ˆì§¸ í•­ (an).
        n (int): në²ˆì§¸ í•­ì˜ ìœ„ì¹˜ (nì€ 1ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤).

    Returns:
        float: ë“±ë¹„ìˆ˜ì—´ì˜ ê³µë¹„ (r).
        str: ì˜¤ë¥˜ ë©”ì‹œì§€ (ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì˜ ê²½ìš°).
    """
    if n <= 1:
        return "nì€ 1ë³´ë‹¤ í° ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤. (ì²«ì§¸ í•­ê³¼ në²ˆì§¸ í•­ì´ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)"
    if first_term == 0:
        # ì²«ì§¸ í•­ì´ 0ì¼ ë•Œ, në²ˆì§¸ í•­ë„ 0ì´ë©´ ê³µë¹„ëŠ” ì •ì˜í•  ìˆ˜ ì—†ìŒ (0, 0, 0, ... ë˜ëŠ” 0, 0, 0, 5, ... ë“±)
        if nth_term == 0:
            return "ì²«ì§¸ í•­ê³¼ në²ˆì§¸ í•­ì´ ëª¨ë‘ 0ì´ë©´ ê³µë¹„ë¥¼ íŠ¹ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        # ì²«ì§¸ í•­ë§Œ 0ì´ë©´ ê³µë¹„ëŠ” ì •ì˜í•  ìˆ˜ ì—†ìŒ (0, r*0, r^2*0... ì¸ë° 0ì´ ì•„ë‹Œ anì´ ë‚˜ì˜¬ ìˆ˜ ì—†ìŒ)
        return "ì²«ì§¸ í•­ì€ 0ì´ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    # an / a1 ê°’ì´ ìŒìˆ˜ì¸ë° (n-1)ì´ ì§ìˆ˜ì¼ ê²½ìš° ì‹¤ìˆ˜ ê³µë¹„ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŒ (ì˜ˆ: r^2 = -4)
    if (nth_term / first_term) < 0 and (n - 1) % 2 == 0:
        return "ìŒìˆ˜ì˜ ì§ìˆ˜ ì œê³±ê·¼ì€ ì‹¤ìˆ˜ ê³µë¹„ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê³µë¹„ê°€ ë³µì†Œìˆ˜ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"

    try:
        # në²ˆì§¸ í•­ì´ 0ì´ê³  ì²«ì§¸ í•­ì´ 0ì´ ì•„ë‹ ê²½ìš° ê³µë¹„ëŠ” 0 (ì˜ˆ: 5, 0, 0, ...)
        if nth_term == 0 and first_term != 0:
            return 0.0
        
        # ì¼ë°˜ì ì¸ ê³µë¹„ ê³„ì‚° ê³µì‹
        ratio_raw = (nth_term / first_term)**(1 / (n - 1))
        
        # ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ë¡œ ì¸í•œ ë¯¸ì„¸í•œ ê°’ ì¡°ì • (0ì— ê°€ê¹Œìš´ ê°’ì€ 0ìœ¼ë¡œ ì²˜ë¦¬)
        if abs(ratio_raw) < 1e-9: # 0.000000001ë³´ë‹¤ ì‘ìœ¼ë©´ 0ìœ¼ë¡œ ê°„ì£¼
            ratio = 0.0
        else:
            ratio = ratio_raw
            
        return ratio
    except ZeroDivisionError:
        # ì´ ì˜ˆì™¸ëŠ” first_termì´ 0ì¼ ë•Œ ì£¼ë¡œ ë°œìƒí•˜ë©°, ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë¨
        return "ê³„ì‚° ì¤‘ 0ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì…ë ¥ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.)"
    except OverflowError:
        return "ê³„ì‚° ê²°ê³¼ê°€ ë„ˆë¬´ ì»¤ì„œ í‘œí˜„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ ê°’ì„ ì¤„ì—¬ì£¼ì„¸ìš”."
    except Exception as e:
        return f"ê³µë¹„ ê³„ì‚° ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"

# --- ìŠ¤íŠ¸ë¦¼ë¦¿ ì•± UI êµ¬ì„± ì‹œì‘ ---

# í˜ì´ì§€ì˜ ì œëª©ê³¼ ë ˆì´ì•„ì›ƒ ì„¤ì •
st.set_page_config(page_title="ë“±ë¹„ìˆ˜ì—´ ê³µë¹„ ê³„ì‚°ê¸°", layout="centered")

# ì•±ì˜ ë©”ì¸ ì œëª©ê³¼ ì„¤ëª…
st.title("ğŸ”¢ ë“±ë¹„ìˆ˜ì—´ ê³µë¹„ ê³„ì‚°ê¸°")
st.markdown("ì²«ì§¸ í•­ ($a_1$)ê³¼ $n$ë²ˆì§¸ í•­ ($a_n$)ì˜ ê°’ì„ ì…ë ¥í•˜ì—¬ ë“±ë¹„(ê³µë¹„)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.")

# ì‚¬ì´ë“œë°”ì— ì…ë ¥ ìœ„ì ¯ ë°°ì¹˜
st.sidebar.header("ê°’ ì…ë ¥")
# number_input ìœ„ì ¯ìœ¼ë¡œ ìˆ«ì ì…ë ¥ ë°›ê¸°
a1 = st.sidebar.number_input("ì²«ì§¸ í•­ ($a_1$)", value=1.0, step=0.1, format="%.2f", help="ë“±ë¹„ìˆ˜ì—´ì˜ ì²« ë²ˆì§¸ ê°’ì…ë‹ˆë‹¤.")
an = st.sidebar.number_input("$n$ë²ˆì§¸ í•­ ($a_n$)", value=2.0, step=0.1, format="%.2f", help="ì•Œê³  ìˆëŠ” íŠ¹ì • í•­ì˜ ê°’ì…ë‹ˆë‹¤.")
n = st.sidebar.number_input("ëª‡ ë²ˆì§¸ í•­ì…ë‹ˆê¹Œ? ($n$)", value=2, min_value=2, step=1, help="ì…ë ¥í•œ $n$ë²ˆì§¸ í•­ì˜ ìˆœì„œì…ë‹ˆë‹¤ (ìµœì†Œ 2).")

# ê³„ì‚° ë²„íŠ¼
if st.sidebar.button("ê³µë¹„ ê³„ì‚°í•˜ê¸°"):
    # n ê°’ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ìœ íš¨ì„± ê²€ì‚¬ (í•¨ìˆ˜ ë‚´ë¶€ì—ì„œë„ í•˜ì§€ë§Œ, UIì—ì„œ ë°”ë¡œ í”¼ë“œë°±)
    if n <= 1:
        st.error("ì˜¤ë¥˜: $n$ì€ 1ë³´ë‹¤ í° ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤. 2 ì´ìƒì˜ ê°’ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        # calculate_geometric_ratio í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ê³µë¹„ ê³„ì‚° ì‹œë„
        result = calculate_geometric_ratio(a1, an, n)
        
        # í•¨ìˆ˜ì˜ ë°˜í™˜ ê°’ì— ë”°ë¼ ê²°ê³¼ ë˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        if isinstance(result, str): # ë°˜í™˜ ê°’ì´ ë¬¸ìì—´ì´ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€
            st.error(f"ì˜¤ë¥˜: {result}")
        else: # ë°˜í™˜ ê°’ì´ ìˆ«ì(float)ì´ë©´ ì„±ê³µì ìœ¼ë¡œ ê³µë¹„ ê³„ì‚°
            st.success(f"ê³„ì‚°ëœ ê³µë¹„ ($r$)ëŠ” **{result:.6f}** ì…ë‹ˆë‹¤.") # ì†Œìˆ˜ì  6ìë¦¬ê¹Œì§€ í‘œì‹œ
            
            # ê³„ì‚° ê²°ê³¼ ê²€ì¦ ì„¹ì…˜
            st.subheader("ê³„ì‚° í™•ì¸")
            st.markdown(f"**ì…ë ¥ëœ ê°’:**")
            st.markdown(f"- ì²«ì§¸ í•­ $a_1 = {a1}$")
            st.markdown(f"- $n$ë²ˆì§¸ í•­ $a_n = {an}$")
            st.markdown(f"- $n = {n}$")
            st.markdown(f"**ê³„ì‚°ëœ ê³µë¹„ $r = {result:.6f}$**")
            
            # ê³„ì‚°ëœ ê³µë¹„ë¡œ në²ˆì§¸ í•­ì„ ë‹¤ì‹œ ê³„ì‚°í•˜ì—¬ ì…ë ¥ëœ në²ˆì§¸ í•­ê³¼ ë¹„êµ
            calculated_an = a1 * (result**(n-1))
            st.markdown(f"**ê²€ì¦:** ê³„ì‚°ëœ ê³µë¹„ë¡œ êµ¬í•œ $n$ë²ˆì§¸ í•­ ($a_1 \\cdot r^{n-1}$) = **{calculated_an:.6f}**")
            
            # ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ë¥¼ ê³ ë ¤í•œ ë¹„êµ (ì•„ì£¼ ì‘ì€ ì˜¤ì°¨ëŠ” í—ˆìš©)
            # ì…ë ¥ëœ anê³¼ ê³„ì‚°ëœ calculated_anì˜ ì°¨ì´ê°€ 0.000001ë³´ë‹¤ ì‘ìœ¼ë©´ ë™ì¼í•˜ë‹¤ê³  ê°„ì£¼
            if abs(calculated_an - an) < 1e-6:
                st.info("ì…ë ¥ëœ $n$ë²ˆì§¸ í•­ê³¼ ê³„ì‚°ëœ $n$ë²ˆì§¸ í•­ì´ ì¼ì¹˜í•©ë‹ˆë‹¤. (ë¯¸ì„¸í•œ ì˜¤ì°¨ ë²”ìœ„ ë‚´)")
            else:
                st.warning(f"ì…ë ¥ëœ $n$ë²ˆì§¸ í•­ ({an:.6f})ê³¼ ê³„ì‚°ëœ $n$ë²ˆì§¸ í•­ ({calculated_an:.6f}) ì‚¬ì´ì— ì•½ê°„ì˜ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¶€ë™ì†Œìˆ˜ì  ì •ë°€ë„ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

# ì•± í•˜ë‹¨ì— ì¶”ê°€ ì •ë³´ ë° ê³µì‹ í‘œì‹œ
st.markdown("---")
st.markdown("ğŸ’¡ ë“±ë¹„ìˆ˜ì—´ ì¼ë°˜í•­: $a_n = a_1 \\cdot r^{n-1}$")
st.markdown("ğŸ’¡ ê³µë¹„ ($r$) ê³„ì‚° ê³µì‹: $r = (a_n / a_1)^{1/(n-1)}$")
